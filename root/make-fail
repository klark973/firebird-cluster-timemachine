#!/bin/sh

# Скрипт эмитации сбоя на текущем сервере         v.0.9.23112014
#
# Может использоваться в тестовых целях не на  "боевом"  сервере.
# Предназначен для тестирования отказоустойчивости  без жёсткого
# выключения сервера и выдёргивания сетевых кабелей.  См. детали
# в руководстве.
#
# Данная программа  является  свободным программным обеспечением.
# Вы можете  распространять  и/или  модифицировать  её  согласно
# условиям Стандартной Общественной Лицензии GNU, опубликованной
# Фондом Свободного Программного Обеспечения,  версии 3 или,  по
# Вашему желанию,  любой  более поздней  версии.  Эта  программа
# распространяется в надежде,  что она будет полезной,  но  БЕЗО
# ВСЯКИХ  ГАРАНТИЙ,  в  том  числе,   подразумеваемых   гарантий
# ТОВАРНОГО СОСТОЯНИЯ ПРИ ПРОДАЖЕ  и  ГОДНОСТИ ДЛЯ ОПРЕДЕЛЁННОГО
# ПРИМЕНЕНИЯ. Смотрите Стандартную Общественную Лицензию GNU для
# получения  дополнительной  информации.    Копия  оригинального
# текста  Стандартной  Общественной  Лицензии  GNU  поставляется
# вместе с этой программой в файле LICENSE.
#
# Copyright (C) 2014 Leonid Krivoshein <klark.devel@gmail.com>
#

exec >/dev/null 2>&1
sleep 10
sync

killall -KILL ucarp
ifconfig bond0:ucarp down
ifconfig bond0 down
ifconfig eth0 down
ifconfig eth1 down
killall -KILL fbguard
killall -KILL fbserver
umount /home || umount -l /home
drbdadm secondary all
drbdadm disconnect all
service networking stop

sleep 180
service networking start || \
	service networking start
sleep 30

ping -c1 -w1 10.0.0.1 && exit 0
reboot
